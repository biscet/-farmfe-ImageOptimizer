"use strict";Object.create,Object.defineProperty,Object.getOwnPropertyDescriptor,Object.getOwnPropertyNames,Object.getPrototypeOf,Object.prototype.hasOwnProperty;Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("pathe"),t=require("fs"),i=require("ansi-colors"),r=require("fs/promises"),o=/(^|[/\\])([^/\\]+?)(?=(\.[^.]+)?$)/;function n(e){return"[object RegExp]"===Object.prototype.toString.call(e)}function a(i){let r=[];try{if(t.existsSync(i)){if(t.lstatSync(i).isDirectory()){t.readdirSync(i).forEach((function(t){const o=a(e.join(i,"/",t));r=r.concat(o)}))}else r.push(i)}}catch(o){}return r}function c(e,t){return i=t,"[object String]"===Object.prototype.toString.call(i)?e===t:n(t)?t.test(e):!!function(e){return Array.isArray(e)}(t)&&t.includes(e);var i}function s(e,t){return t?e:i.unstyle(e)}const l=async(t,i,r)=>{const o=(await import("sharp")).default,n=e.extname(t).replace(".","").toLowerCase();return await o(i,{animated:"gif"===n}).toFormat(n,r[n]).toBuffer()},u=async(i,o,n,a,c)=>{try{let c,s;const u=e.join(n.cacheLocation,i);if(!0===n.cache&&t.existsSync(u))c=await r.readFile(u),s=!0;else{const e=l;c=await e(i,o,n),s=!1}!0!==n.cache||s||(t.existsSync(e.dirname(u))||await r.mkdir(e.dirname(u),{recursive:!0}),await r.writeFile(u,c));const d=c.byteLength,g=o.byteLength,p=d>=g;return a.set(i,{size:d/1024,oldSize:g/1024,ratio:Math.floor(100*(d/g-1)),skipWrite:p,isCached:s}),{content:c,skipWrite:p}}catch(s){return c.set(i,s.message),{}}},d=(e,t,i)=>i.include?e.reduce(((e,r)=>(c(t(r),i.include)&&e.push(r),e)),[]):e.reduce(((e,r)=>{var o;if(null==(o=i.test)?void 0:o.test(r)){c(t(r),i.exclude)||e.push(r)}return e}),[]),g=async e=>{!0!==e.cache||t.existsSync(e.cacheLocation)||await r.mkdir(e.cacheLocation,{recursive:!0})},p={logStats:!0,ansiColors:!0,includePublic:!0,exclude:void 0,include:void 0,test:/\.(jpe?g|png)$/i,png:{quality:95,compressionLevel:5},jpeg:{quality:20},jpg:{quality:20},cache:!1,cacheLocation:void 0};exports.FarmfeImageOptimizer=function(c={}){const l=function(e,t){const i=e=>{if("object"!=typeof e||n(e)||null===e)return e;const t=Array.isArray(e)?[]:{};for(const r in e){const o=e[r];t[r]=i(o)}return t},r=i(e);for(const o in t)void 0===r[o]&&(r[o]=t[o]);return r}(c,p);let f,m,y;const h=new Map,b=new Map,$=new Map;return{name:"farmfe-image-optimizer",enforce:"post",apply:"build",configResolved(e){y=e,f=e.build.outDir,"string"==typeof e.publicDir&&(m=e.publicDir.replace(/\\/g,"/"))},generateBundle:async(e,t)=>{const i=Object.keys(t),r=d(i,(e=>t[e].name),l);if(r.length>0){await g(l);const e=r.map((async e=>{const i=t[e].source,{content:r,skipWrite:o}=await u(e,i,l,h,$);(null==r?void 0:r.length)>0&&!o&&(t[e].source=r)}));await Promise.all(e)}},async closeBundle(){if(m&&l.includePublic){const i=a(m),n=d(i,(t=>function(e){var t;return null==(t=e.match(o))?void 0:t[2]}(t)+e.extname(t)),l);if(n.length>0){await g(l);const i=n.map((async i=>{const o=i.replace(m+e.sep,""),n=e.join(y.root,f,o);if(!1===t.existsSync(n))return;const{mtimeMs:a}=await r.stat(n);if(a<=(b.get(o)||0))return;const c=await r.readFile(n),{content:s,skipWrite:d}=await u(o,c,l,h,$);(null==s?void 0:s.length)>0&&!d&&(await r.writeFile(n,s),b.set(o,Date.now()))}));await Promise.all(i)}}h.size>0&&l.logStats&&function(t,r,o){t.logger.info(s(`\nâœ¨ ${i.cyan("[farmfe-image-optimizer]")} - optimized images successfully: `,o));const n=Array.from(r.keys(),(e=>e.length)),a=Array.from(r.values(),(e=>`${Math.floor(100*e.ratio)}`.length)),c=Math.max(...n),l=Math.max(...a);let u=0,d=0;if(r.forEach(((r,n)=>{const{size:a,oldSize:g,ratio:p,skipWrite:f,isCached:m}=r,y=p>0?i.red(`+${p}%`):p<=0?i.green(`${p}%`):"",h=f?`${i.yellow.bold("skipped")} ${i.dim(`original: ${g.toFixed(2)} kB <= optimized: ${a.toFixed(2)} kB`)}`:m?`${i.yellow.bold("cached")} ${i.dim(`original: ${g.toFixed(2)} kB; cached: ${a.toFixed(2)} kB`)}`:i.dim(`${g.toFixed(2)} kB â­¢  ${a.toFixed(2)} kB`);t.logger.info(s(i.dim(e.basename(t.build.outDir))+"/"+i.blueBright(n)+" ".repeat(2+c-n.length)+i.gray(`${y} ${" ".repeat(l-`${p}`.length)}`)+" "+h,o)),f||(u+=g,d+=g-a)})),d>0){const e=`${d.toFixed(2)}kB`,r=`${u.toFixed(2)}kB`,n=`${Math.round(d/u*100)}%`;t.logger.info(s(`\nðŸ’° total savings = ${i.green(e)}/${i.green(r)} â‰ˆ ${i.green(n)}`,o))}t.logger.info("\n")}(y,h,l.ansiColors),$.size>0&&function(t,r,o){t.logger.info(s(`\nðŸš¨ ${i.red("[farmfe-image-optimizer]")} - errors during optimization: `,o));const n=Array.from(r.keys(),(e=>e.length)),a=Math.max(...n);r.forEach(((r,n)=>{t.logger.error(s(`${i.dim(e.basename(t.build.outDir))}/${i.blueBright(n)}${" ".repeat(2+a-n.length)} ${i.red(r)}`,o))})),t.logger.info("\n")}(y,$,l.ansiColors)}}};
